name: Android CI/CD (Shared)

on:
  workflow_call:
    inputs:
      # ==================== é¡¹ç›®é…ç½® ====================
      app_name:
        description: 'åº”ç”¨åç§°'
        type: string
        required: true
      build_flavor:
        description: 'æž„å»ºå˜ä½“: release (å•flavor) æˆ– prodRelease (å¤šflavor)'
        type: string
        required: true
      config_path:
        description: 'é…ç½®æ–‡ä»¶è·¯å¾„ (ç”¨äºŽæå–ç‰ˆæœ¬å·)'
        type: string
        required: true
      config_block:
        description: 'awk æ¨¡å¼åŒ¹é…é…ç½®å— (ç©º=ç›´æŽ¥grep)'
        type: string
        required: false
        default: ''
      ad_config_name:
        description: 'å¹¿å‘Šé…ç½®æ–‡ä»¶å: boost_config æˆ– lum.config'
        type: string
        required: true
      keystore_filename:
        description: 'Keystore æ–‡ä»¶å'
        type: string
        required: false
        default: 'release-keystore.jks'
      has_maven_credentials:
        description: 'æ˜¯å¦éœ€è¦ Maven å‡­è¯'
        type: boolean
        required: false
        default: false
      decode_secrets_properties:
        description: 'æ˜¯å¦è§£ç  secrets.properties'
        type: boolean
        required: false
        default: false
      decode_google_services_json:
        description: 'æ˜¯å¦è§£ç  google-services.json'
        type: boolean
        required: false
        default: false
      # ==================== è¿è¡Œæ—¶å‚æ•° ====================
      build_type:
        description: 'æž„å»ºç±»åž‹'
        type: string
        required: true
      create_release:
        description: 'åˆ›å»º GitHub Release'
        type: boolean
        required: false
        default: true
      notify_feishu:
        description: 'å‘é€é£žä¹¦é€šçŸ¥'
        type: boolean
        required: false
        default: true
      also_build_apk:
        description: 'åŒæ—¶æž„å»º APK'
        type: boolean
        required: false
        default: false
      upload_debug_artifact:
        description: 'ä¸Šä¼  Debug äº§ç‰©'
        type: boolean
        required: false
        default: false
      publish_to_play_store:
        description: 'å‘å¸ƒåˆ° Google Play'
        type: boolean
        required: false
        default: false
      play_store_track:
        description: 'å‘å¸ƒè½¨é“'
        type: string
        required: false
        default: 'internal'
      rollout_percentage:
        description: 'ç°åº¦ç™¾åˆ†æ¯”'
        type: string
        required: false
        default: '20'
      custom_rollout_percentage:
        description: 'è‡ªå®šä¹‰ç°åº¦ç™¾åˆ†æ¯”'
        type: string
        required: false
        default: ''
      previous_version_action:
        description: 'ä¸Šä¸€ç‰ˆæœ¬å¤„ç†'
        type: string
        required: false
        default: 'complete'

env:
  JAVA_VERSION: '17'

permissions:
  contents: write
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Derive build configuration
        id: config
        run: |
          FLAVOR="${{ inputs.build_flavor }}"
          APP="${{ inputs.app_name }}"
          if [ "$FLAVOR" = "release" ]; then
            echo "debug_task=assembleDebug" >> $GITHUB_OUTPUT
            echo "release_task=assembleRelease" >> $GITHUB_OUTPUT
            echo "aab_task=bundleRelease" >> $GITHUB_OUTPUT
            echo "debug_apk=app/build/outputs/apk/debug/app-debug.apk" >> $GITHUB_OUTPUT
            echo "release_apk=app/build/outputs/apk/release/app-release.apk" >> $GITHUB_OUTPUT
            echo "aab_path=app/build/outputs/bundle/release/*.aab" >> $GITHUB_OUTPUT
            echo "manifest_dir=release/processReleaseMainManifest" >> $GITHUB_OUTPUT
            echo "assets_dir=release/mergeReleaseAssets" >> $GITHUB_OUTPUT
          else
            echo "debug_task=assembleDevDebug" >> $GITHUB_OUTPUT
            echo "release_task=assembleProdRelease" >> $GITHUB_OUTPUT
            echo "aab_task=bundleProdRelease" >> $GITHUB_OUTPUT
            echo "debug_apk=app/build/outputs/apk/dev/debug/${APP}-dev-debug.apk" >> $GITHUB_OUTPUT
            echo "release_apk=app/build/outputs/apk/prod/release/${APP}-prod-release.apk" >> $GITHUB_OUTPUT
            echo "aab_path=app/build/outputs/bundle/prodRelease/*.aab" >> $GITHUB_OUTPUT
            echo "manifest_dir=prodRelease/processProdReleaseMainManifest" >> $GITHUB_OUTPUT
            echo "assets_dir=prodRelease/mergeProdReleaseAssets" >> $GITHUB_OUTPUT
          fi

      - name: Cleanup old artifacts (keep latest 3)
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ§¹ æ¸…ç†æ—§çš„ artifactsï¼Œä¿ç•™æœ€æ–° 3 ä¸ª..."
          for ARTIFACT_NAME in "release-apk" "release-aab" "debug-apk"; do
            echo "ðŸ“¦ å¤„ç† $ARTIFACT_NAME..."
            ARTIFACTS=$(gh api repos/${{ github.repository }}/actions/artifacts \
              --jq ".artifacts | map(select(.name == \"$ARTIFACT_NAME\")) | sort_by(.created_at) | reverse | .[3:] | .[].id")
            if [ -z "$ARTIFACTS" ]; then
              echo "  âœ… $ARTIFACT_NAME æ— éœ€æ¸…ç†"
            else
              for id in $ARTIFACTS; do
                echo "  ðŸ—‘ï¸ åˆ é™¤ $ARTIFACT_NAME artifact $id"
                gh api -X DELETE repos/${{ github.repository }}/actions/artifacts/$id || true
              done
            fi
          done
          echo "âœ… æ¸…ç†å®Œæˆ"

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Decode Keystore
        if: inputs.build_type != 'debug'
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/${{ inputs.keystore_filename }}

      - name: Decode secrets.properties
        if: inputs.decode_secrets_properties
        run: echo "${{ secrets.SECRETS_PROPERTIES_BASE64 }}" | base64 -d > secrets.properties

      - name: Decode google-services.json
        if: inputs.decode_google_services_json
        run: |
          mkdir -p app/src/prod
          echo "${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}" | base64 -d > app/src/prod/google-services.json

      - name: Print release configuration (pre-build)
        if: inputs.build_type != 'debug'
        run: |
          CONFIG="${{ inputs.config_path }}"
          BLOCK="${{ inputs.config_block }}"

          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              ðŸ“‹ Release Configuration Summary               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          echo "â”Œâ”€â”€â”€ ðŸ“¦ åŸºç¡€ä¿¡æ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          APP_ID=""
          VER_NAME=""
          VER_CODE=""
          if [ -n "$BLOCK" ]; then
            BLOCK_TEXT=$(awk "/$BLOCK/,/\]/" "$CONFIG")
            APP_ID=$(echo "$BLOCK_TEXT" | grep 'applicationId' | head -1 | sed 's/.*"\(.*\)".*/\1/')
            VER_NAME=$(echo "$BLOCK_TEXT" | grep 'versionName' | head -1 | sed 's/.*"\(.*\)".*/\1/')
            VER_CODE=$(echo "$BLOCK_TEXT" | grep 'versionCode' | head -1 | sed 's/[^0-9]*\([0-9]*\).*/\1/')
          fi
          [ -z "$APP_ID" ] && APP_ID=$(grep 'applicationId' "$CONFIG" | head -1 | sed 's/.*"\(.*\)".*/\1/' || echo 'N/A')
          [ -z "$VER_NAME" ] && VER_NAME=$(grep 'versionName' "$CONFIG" | head -1 | sed 's/.*"\(.*\)".*/\1/' || echo 'N/A')
          [ -z "$VER_CODE" ] && VER_CODE=$(grep 'versionCode' "$CONFIG" | head -1 | sed 's/[^0-9]*\([0-9]*\).*/\1/' || echo 'N/A')
          echo "â”‚ Application ID:  $APP_ID"
          echo "â”‚ Version Name:    $VER_NAME"
          echo "â”‚ Version Code:    $VER_CODE"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""

          # Firebase config (search common paths)
          GOOGLE_SERVICES=""
          for path in "app/src/release/google-services.json" "app/src/prod/google-services.json" "app/google-services.json"; do
            if [ -f "$path" ]; then GOOGLE_SERVICES="$path"; break; fi
          done

          if [ -n "$GOOGLE_SERVICES" ]; then
            echo "â”Œâ”€â”€â”€ ðŸ”¥ Firebase é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "â”‚ Source:          $GOOGLE_SERVICES"
            echo "â”‚ Project ID:      $(grep -o '"project_id": "[^"]*"' "$GOOGLE_SERVICES" | head -1 | sed 's/.*"\([^"]*\)"/\1/' || echo 'N/A')"
            echo "â”‚ Package Name:    $(grep -o '"package_name": "[^"]*"' "$GOOGLE_SERVICES" | head -1 | sed 's/.*"\([^"]*\)"/\1/' || echo 'N/A')"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          fi
          echo ""
          echo "âœ… æºç é…ç½®æ ¸æŸ¥å®Œæˆ"
          echo "â„¹ï¸ å¹¿å‘Šèšåˆå¹³å°è¯¦ç»†é…ç½®å°†åœ¨æž„å»ºåŽä»Ž ${{ inputs.ad_config_name }} è§£å¯†è¾“å‡º"

      - name: Build Debug APK
        if: inputs.build_type == 'debug' || inputs.build_type == 'both'
        env:
          ORG_GRADLE_PROJECT_MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          ORG_GRADLE_PROJECT_MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
        run: ./gradlew ${{ steps.config.outputs.debug_task }}

      - name: Build Release APK
        if: |
          (inputs.build_type == 'release' || inputs.build_type == 'both' || inputs.build_type == '') &&
          inputs.build_type != 'aab' &&
          (!inputs.publish_to_play_store || inputs.also_build_apk)
        env:
          KEYSTORE_FILE: ${{ inputs.keystore_filename }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          ORG_GRADLE_PROJECT_MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          ORG_GRADLE_PROJECT_MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
        run: ./gradlew ${{ steps.config.outputs.release_task }}

      - name: Build Release AAB (for Google Play)
        if: inputs.publish_to_play_store || inputs.build_type == 'aab'
        env:
          KEYSTORE_FILE: ${{ inputs.keystore_filename }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          ORG_GRADLE_PROJECT_MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          ORG_GRADLE_PROJECT_MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
        run: ./gradlew ${{ steps.config.outputs.aab_task }}

      - name: Get version info
        id: version
        run: |
          CONFIG="${{ inputs.config_path }}"
          BLOCK="${{ inputs.config_block }}"

          if [ ! -f "$CONFIG" ]; then
            echo "âŒ Error: $CONFIG not found"
            exit 1
          fi

          if [ -n "$BLOCK" ]; then
            BLOCK_TEXT=$(awk "/$BLOCK/,/\]/" "$CONFIG")
            VERSION_NAME=$(echo "$BLOCK_TEXT" | grep "versionName" | head -1 | sed 's/.*"\(.*\)".*/\1/')
            VERSION_CODE=$(echo "$BLOCK_TEXT" | grep "versionCode" | head -1 | sed 's/[^0-9]*\([0-9]*\).*/\1/')
            PACKAGE_NAME=$(echo "$BLOCK_TEXT" | grep "applicationId" | head -1 | sed 's/.*"\(.*\)".*/\1/')
          fi

          # Fallback to global grep if block extraction missed any field
          if [ -z "$VERSION_NAME" ]; then
            VERSION_NAME=$(grep "versionName" "$CONFIG" | head -1 | sed 's/.*"\(.*\)".*/\1/')
          fi
          if [ -z "$VERSION_CODE" ]; then
            VERSION_CODE=$(grep "versionCode" "$CONFIG" | head -1 | sed 's/[^0-9]*\([0-9]*\).*/\1/')
          fi
          if [ -z "$PACKAGE_NAME" ]; then
            PACKAGE_NAME=$(grep "applicationId" "$CONFIG" | head -1 | sed 's/.*"\(.*\)".*/\1/')
          fi

          if [ -z "$VERSION_NAME" ] || [ -z "$VERSION_CODE" ] || [ -z "$PACKAGE_NAME" ]; then
            echo "âŒ Error: Failed to extract version info from $CONFIG"
            exit 1
          fi

          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "build_time=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT

          echo "âœ… Version Name: $VERSION_NAME"
          echo "âœ… Version Code: $VERSION_CODE"
          echo "ðŸ“¦ Package Name: $PACKAGE_NAME"

      - name: Print ad configuration (post-build)
        if: inputs.build_type != 'debug'
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ðŸ“º Ad Configuration (${{ inputs.ad_config_name }})              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # AdMob App ID from merged manifest
          MANIFEST_FILE="app/build/intermediates/merged_manifest/${{ steps.config.outputs.manifest_dir }}/AndroidManifest.xml"
          echo "â”Œâ”€â”€â”€ ðŸ·ï¸ AdMob App ID (AndroidManifest.xml) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if [ -f "$MANIFEST_FILE" ]; then
            ADMOB_APP_ID=$(grep -A1 'com.google.android.gms.ads.APPLICATION_ID' "$MANIFEST_FILE" | grep 'android:value' | sed 's/.*"\(.*\)".*/\1/')
            echo "â”‚ AdMob App ID:    $ADMOB_APP_ID"
          else
            echo "â”‚ âš ï¸ merged AndroidManifest.xml ä¸å­˜åœ¨"
          fi
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""

          # Decrypt ad config (AES-256-CBC, same key/IV for both boost_config and lum.config)
          AD_KEY="6ebd5bacec777becb70c4a04b9ff68e3229e6f71f3a4ca40932f53548d402fe4"
          AD_IV="3f20787529787aec5a472f07b0ef4bea"
          AD_FILE="app/build/intermediates/assets/${{ steps.config.outputs.assets_dir }}/${{ inputs.ad_config_name }}"

          if [ -f "$AD_FILE" ]; then
            DECRYPTED=$(base64 -d "$AD_FILE" | openssl enc -d -aes-256-cbc -K "$AD_KEY" -iv "$AD_IV" 2>/dev/null) || true

            if [ -n "$DECRYPTED" ]; then
              # Try to extract ad scene names from config for cross-validation
              GRADLE_SCENES=""
              for f in "${{ inputs.config_path }}" "config.gradle" "config/config.gradle"; do
                if [ -f "$f" ]; then
                  GRADLE_SCENES=$(awk '/adScenes.*=.*\[/,/\]/' "$f" 2>/dev/null | grep -o '"[^"]*"' | tr -d '"' | sort) || true
                  if [ -n "$GRADLE_SCENES" ]; then break; fi
                fi
              done
              export GRADLE_SCENES="${GRADLE_SCENES:-}"

              cat << 'PYEOF' > /tmp/ad_parser.py
          import json, sys, os

          config = json.load(sys.stdin)

          print('â”Œâ”€â”€â”€ ðŸ“± å¹¿å‘Šèšåˆå¹³å° (v' + config.get('version', '?') + ') â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€')
          print('â”‚ Global Switch:   ' + str(config.get('switch', '?')))
          print('â”‚')

          networks = config.get('networks', {})

          admob = networks.get('admob', {})
          print('â”‚ [AdMob]          network_id=' + str(admob.get('id', '?')))

          topon = networks.get('topOn', {})
          print('â”‚ [TopOn]          network_id=' + str(topon.get('id', '?')))
          print('â”‚   App ID:        ' + topon.get('app_id', 'æœªé…ç½®'))
          print('â”‚   App Key:       ' + topon.get('app_key', 'æœªé…ç½®'))

          maxn = networks.get('max', {})
          sdk_key = maxn.get('applovin_sdk_key', '')
          print('â”‚ [MAX/AppLovin]   network_id=' + str(maxn.get('id', '?')))
          if sdk_key:
              print('â”‚   SDK Key:       ' + sdk_key[:20] + '...' + sdk_key[-10:] + ' (' + str(len(sdk_key)) + ' chars)')
          else:
              print('â”‚   SDK Key:       æœªé…ç½®')

          adx = networks.get('adx', {})
          if adx:
              print('â”‚ [ADX]            network_id=' + str(adx.get('id', '?')))
              print('â”‚   App ID:        ' + adx.get('app_id', 'æœªé…ç½®'))

          print('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€')
          print()

          print('â”Œâ”€â”€â”€ ðŸ“º å¹¿å‘Šåœºæ™¯ â†” å¹¿å‘Šå•å…ƒ ID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€')

          strategies = {}
          for s in (config.get('strategies') or []):
              sid = s['id']
              strategies[int(sid) if isinstance(sid, str) else sid] = s

          network_names = {2: 'AdMob', 5: 'MAX', 26: 'TopOn', 66: 'ADX'}
          ad_type_names = {1: 'æ’å±', 2: 'æ¿€åŠ±', 3: 'åŽŸç”Ÿ', 4: 'å¼€å±', 5: 'Banner'}

          for scene in (config.get('scenes') or []):
              name = scene['name']
              sid = scene['strategy_id']
              switch = 'âœ…' if scene.get('switch', 1) == 1 else 'âŒ'
              ad_type = ad_type_names.get(scene.get('ad_type', 0), str(scene.get('ad_type', '?')))
              bidding = 'ç«žä»·' if scene.get('enable_client_bidding', False) else 'ç€‘å¸ƒæµ'
              print(f'â”‚ {switch} {name}')
              print(f'â”‚   ç±»åž‹: {ad_type}  |  æ¨¡å¼: {bidding}  |  ç­–ç•¥ID: {sid}')
              strategy = strategies.get(sid)
              if strategy:
                  for unit in strategy.get('ad_units', []):
                      net = network_names.get(unit.get('network', 0), 'N' + str(unit.get('network', '?')))
                      print(f'â”‚   â†’ [{net}] {unit["id"]}')
              else:
                  print(f'â”‚   â†’ âš ï¸ ç­–ç•¥ {sid} æœªæ‰¾åˆ°')

          print('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€')
          print()

          ad_scenes = set(s['name'] for s in (config.get('scenes') or []))
          gradle_scenes_str = os.environ.get('GRADLE_SCENES', '').strip()
          gradle_scenes = set(gradle_scenes_str.split('\n')) if gradle_scenes_str else set()

          if gradle_scenes:
              print('â”Œâ”€â”€â”€ ðŸ” å¹¿å‘Šåœºæ™¯äº¤å‰æ ¡éªŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€')
              missing = gradle_scenes - ad_scenes
              extra = ad_scenes - gradle_scenes
              if not missing and not extra:
                  print('â”‚ âœ… config å’Œå¹¿å‘Šé…ç½®åœºæ™¯å®Œå…¨åŒ¹é…')
              else:
                  if missing:
                      for s in sorted(missing):
                          print(f'â”‚ âš ï¸ config ä¸­æœ‰ä½†å¹¿å‘Šé…ç½®ä¸­ç¼ºå¤±: {s}')
                  if extra:
                      for s in sorted(extra):
                          print(f'â”‚ â„¹ï¸ å¹¿å‘Šé…ç½®ä¸­æœ‰ä½† config ä¸­æœªå®šä¹‰: {s}')
              print('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€')
          PYEOF
              echo "$DECRYPTED" | python3 /tmp/ad_parser.py
            else
              echo "â”Œâ”€â”€â”€ ðŸ“± å¹¿å‘Šèšåˆå¹³å° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
              echo "â”‚ âš ï¸ ${{ inputs.ad_config_name }} è§£å¯†å¤±è´¥"
              echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            fi
          else
            echo "â”Œâ”€â”€â”€ ðŸ“± å¹¿å‘Šèšåˆå¹³å° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "â”‚ âš ï¸ ${{ inputs.ad_config_name }} æ–‡ä»¶ä¸å­˜åœ¨ (éœ€è¦ release/aab æž„å»º)"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          fi

          echo ""
          echo "âœ… å¹¿å‘Šé…ç½®æ ¸æŸ¥å®Œæˆ"

      - name: Generate Changelog
        id: changelog
        if: inputs.publish_to_play_store && inputs.play_store_track == 'production'
        run: |
          chmod +x scripts/generate-changelog.sh
          ./scripts/generate-changelog.sh --dry-run

      - name: Rename APK files
        if: ${{ (!inputs.publish_to_play_store || inputs.also_build_apk) || inputs.build_type == 'debug' || inputs.build_type == 'both' }}
        run: |
          mkdir -p artifacts
          if [ -f "${{ steps.config.outputs.debug_apk }}" ]; then
            cp "${{ steps.config.outputs.debug_apk }}" "artifacts/${{ inputs.app_name }}-v${{ steps.version.outputs.version_name }}-debug.apk"
          fi
          if [ -f "${{ steps.config.outputs.release_apk }}" ]; then
            cp "${{ steps.config.outputs.release_apk }}" "artifacts/${{ inputs.app_name }}-v${{ steps.version.outputs.version_name }}-release.apk"
          fi

      - name: Upload Debug APK artifact
        if: inputs.upload_debug_artifact && (inputs.build_type == 'debug' || inputs.build_type == 'both')
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: debug-apk
          path: artifacts/*-debug.apk
          if-no-files-found: ignore

      - name: Upload Release APK artifact
        if: ${{ !inputs.publish_to_play_store || inputs.also_build_apk }}
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: release-apk
          path: artifacts/*-release.apk
          if-no-files-found: ignore

      - name: Upload Release AAB artifact
        if: inputs.publish_to_play_store || inputs.build_type == 'aab'
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: release-aab
          path: ${{ steps.config.outputs.aab_path }}
          if-no-files-found: warn

      - name: Create Stable Tag
        if: inputs.publish_to_play_store && inputs.play_store_track == 'production'
        run: |
          VERSION="v${{ steps.version.outputs.version_name }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "âš ï¸ Tag $VERSION å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          else
            echo "ðŸ“Œ åˆ›å»ºæ­£å¼ Tag: $VERSION"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "$VERSION" -m "Release $VERSION"
            git push origin "$VERSION"
            echo "âœ… Tag $VERSION åˆ›å»ºæˆåŠŸ"
          fi

      - name: Create Release
        if: inputs.create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ (inputs.publish_to_play_store && inputs.play_store_track == 'production') && format('v{0}', steps.version.outputs.version_name) || format('v{0}-{1}', steps.version.outputs.version_name, steps.version.outputs.build_time) }}
          name: Release v${{ steps.version.outputs.version_name }}
          body: |
            ## ${{ inputs.app_name }} v${{ steps.version.outputs.version_name }}

            **ç‰ˆæœ¬ä¿¡æ¯**
            - Version Name: ${{ steps.version.outputs.version_name }}
            - Version Code: ${{ steps.version.outputs.version_code }}
            - Build Time: ${{ steps.version.outputs.build_time }}

            ## ä¸‹è½½

            ç‚¹å‡»ä¸‹æ–¹ Assets ä¸­çš„ APK æ–‡ä»¶ä¸‹è½½å®‰è£…ã€‚
          files: artifacts/*.apk
          fail_on_unmatched_files: false
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate rollout settings
        id: rollout
        if: inputs.publish_to_play_store
        run: |
          TRACK="${{ inputs.play_store_track }}"
          CUSTOM_PERCENTAGE="${{ inputs.custom_rollout_percentage }}"
          CHOICE_PERCENTAGE="${{ inputs.rollout_percentage }}"

          if [ -n "$CUSTOM_PERCENTAGE" ]; then
            PERCENTAGE="$CUSTOM_PERCENTAGE"
            echo "ðŸ“ ä½¿ç”¨è‡ªå®šä¹‰ç°åº¦ç™¾åˆ†æ¯”: ${PERCENTAGE}%"
          else
            PERCENTAGE="$CHOICE_PERCENTAGE"
            echo "ðŸ“ ä½¿ç”¨é¢„è®¾ç°åº¦ç™¾åˆ†æ¯”: ${PERCENTAGE}%"
          fi

          if ! [[ "$PERCENTAGE" =~ ^[0-9]+$ ]] || [ "$PERCENTAGE" -lt 1 ] || [ "$PERCENTAGE" -gt 100 ]; then
            echo "âŒ Error: ç°åº¦ç™¾åˆ†æ¯”å¿…é¡»æ˜¯ 1-100 ä¹‹é—´çš„æ•´æ•°ï¼Œå½“å‰å€¼: $PERCENTAGE"
            exit 1
          fi

          if [ "$TRACK" = "production" ]; then
            echo "âš ï¸ =================================="
            echo "âš ï¸ è­¦å‘Š: æ­£åœ¨å‘å¸ƒåˆ° PRODUCTION è½¨é“!"
            echo "âš ï¸ =================================="
          fi

          echo "ðŸ“‹ å‘å¸ƒé…ç½®:"
          echo "   è½¨é“: $TRACK"
          echo "   ç°åº¦: ${PERCENTAGE}%"
          echo "   ä¸Šä¸€ç‰ˆæœ¬: ${{ inputs.previous_version_action }}"

          if [ "$PERCENTAGE" = "100" ]; then
            echo "fraction=" >> $GITHUB_OUTPUT
            echo "status=completed" >> $GITHUB_OUTPUT
            echo "ðŸ“Š å‘å¸ƒè®¾ç½®: 100% å…¨é‡å‘å¸ƒ"
          else
            FRACTION=$(awk "BEGIN {printf \"%.2f\", $PERCENTAGE / 100}")
            echo "fraction=$FRACTION" >> $GITHUB_OUTPUT
            echo "status=inProgress" >> $GITHUB_OUTPUT
            echo "ðŸ“Š å‘å¸ƒè®¾ç½®: ${PERCENTAGE}% ç°åº¦å‘å¸ƒ (userFraction: $FRACTION)"
          fi

      - name: Handle previous version
        if: inputs.publish_to_play_store && inputs.previous_version_action != 'keep'
        continue-on-error: true
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          chmod +x scripts/manage-previous-release.sh
          ./scripts/manage-previous-release.sh \
            "${{ steps.version.outputs.package_name }}" \
            "${{ inputs.play_store_track }}" \
            "${{ inputs.previous_version_action }}" \
            "$GOOGLE_PLAY_SERVICE_ACCOUNT_JSON"

      - name: Upload to Google Play
        if: inputs.publish_to_play_store
        continue-on-error: true
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ steps.version.outputs.package_name }}
          releaseFiles: ${{ steps.config.outputs.aab_path }}
          track: ${{ inputs.play_store_track }}
          status: ${{ steps.rollout.outputs.status }}
          userFraction: ${{ steps.rollout.outputs.fraction }}
          whatsNewDirectory: distribution/whatsnew

      - name: Upload APK to file hosting
        id: upload
        if: always() && !cancelled()
        run: |
          APK_FILE="artifacts/${{ inputs.app_name }}-v${{ steps.version.outputs.version_name }}-release.apk"
          if [ -f "$APK_FILE" ]; then
            for i in 1 2 3; do
              echo "ðŸ“¤ ä¸Šä¼ å°è¯• $i/3..."
              RESPONSE=$(curl --connect-timeout 30 --max-time 300 -F "file=@${APK_FILE}" https://tmpfiles.org/api/v1/upload 2>/dev/null)
              RAW_URL=$(echo "$RESPONSE" | grep -o '"url":"[^"]*"' | cut -d'"' -f4)
              if [ -n "$RAW_URL" ]; then
                DOWNLOAD_URL=$(echo "$RAW_URL" | sed 's|tmpfiles.org/|tmpfiles.org/dl/|')
                echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
                echo "âœ… APK uploaded: $DOWNLOAD_URL"
                break
              fi
              if [ $i -lt 3 ]; then
                echo "âš ï¸ ä¸Šä¼ å¤±è´¥ï¼Œ10ç§’åŽé‡è¯•..."
                sleep 10
              fi
            done
            if [ -z "$DOWNLOAD_URL" ] || [[ "$DOWNLOAD_URL" != http* ]]; then
              echo "âš ï¸ Failed to upload APK after 3 attempts"
              echo "download_url=" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ APK file not found"
            echo "download_url=" >> $GITHUB_OUTPUT
          fi

      - name: Notify Feishu
        if: always() && !cancelled() && !failure() && inputs.notify_feishu
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          if [ -z "$FEISHU_WEBHOOK" ]; then
            echo "âš ï¸ FEISHU_WEBHOOK not configured, skipping notification"
            exit 0
          fi

          DOWNLOAD_URL="${{ steps.upload.outputs.download_url }}"
          VERSION_NAME="${{ steps.version.outputs.version_name }}"
          VERSION_CODE="${{ steps.version.outputs.version_code }}"
          BUILD_TIME="${{ steps.version.outputs.build_time }}"

          if [ -n "$DOWNLOAD_URL" ] && [[ "$DOWNLOAD_URL" == http* ]]; then
            QR_CODE_URL="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${DOWNLOAD_URL}"
            cat > /tmp/feishu_payload.json << PAYLOAD_EOF
          {
            "msg_type": "interactive",
            "card": {
              "header": {
                "title": {"tag": "plain_text", "content": "âœ… ${{ inputs.app_name }} æž„å»ºæˆåŠŸ"},
                "template": "green"
              },
              "elements": [
                {"tag": "div", "text": {"tag": "lark_md", "content": "**ç‰ˆæœ¬ä¿¡æ¯**\nâ€¢ Version: ${VERSION_NAME} (${VERSION_CODE})\nâ€¢ æž„å»ºæ—¶é—´: ${BUILD_TIME}\nâ€¢ åˆ†æ”¯: ${{ github.ref_name }}"}},
                {"tag": "hr"},
                {"tag": "div", "text": {"tag": "lark_md", "content": "**ä¸‹è½½é“¾æŽ¥ï¼ˆ1å°æ—¶æœ‰æ•ˆï¼‰**\n[ç‚¹å‡»æŸ¥çœ‹äºŒç»´ç ](${QR_CODE_URL})"}},
                {"tag": "action", "actions": [{"tag": "button", "text": {"tag": "plain_text", "content": "ðŸ“¥ ä¸‹è½½ APK"}, "type": "primary", "url": "${DOWNLOAD_URL}"}]}
              ]
            }
          }
          PAYLOAD_EOF
          else
            cat > /tmp/feishu_payload.json << PAYLOAD_EOF
          {
            "msg_type": "interactive",
            "card": {
              "header": {
                "title": {"tag": "plain_text", "content": "âœ… ${{ inputs.app_name }} æž„å»ºæˆåŠŸ"},
                "template": "green"
              },
              "elements": [
                {"tag": "div", "text": {"tag": "lark_md", "content": "**ç‰ˆæœ¬ä¿¡æ¯**\nâ€¢ Version: ${VERSION_NAME} (${VERSION_CODE})\nâ€¢ æž„å»ºæ—¶é—´: ${BUILD_TIME}\nâ€¢ åˆ†æ”¯: ${{ github.ref_name }}"}},
                {"tag": "hr"},
                {"tag": "div", "text": {"tag": "lark_md", "content": "**APK ä¸‹è½½é“¾æŽ¥ä¸å¯ç”¨**\nè¯·å‰å¾€ [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) ä¸‹è½½ Artifacts"}}
              ]
            }
          }
          PAYLOAD_EOF
          fi

          echo "ðŸ“¤ Sending Feishu notification..."
          echo "ðŸ“‹ Payload preview:"
          cat /tmp/feishu_payload.json | head -c 500
          echo ""

          RESPONSE=$(curl -s -X POST "$FEISHU_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d @/tmp/feishu_payload.json)

          echo "ðŸ“¨ Feishu API response: $RESPONSE"

          STATUS_CODE=$(echo "$RESPONSE" | python3 -c "import json,sys; d=json.load(sys.stdin); print(d.get('StatusCode', d.get('code', -1)))" 2>/dev/null || echo "-1")
          if [ "$STATUS_CODE" = "0" ]; then
            echo "âœ… Feishu notification sent successfully"
          else
            echo "âŒ Feishu notification failed! StatusCode=$STATUS_CODE"
            echo "Full response: $RESPONSE"
          fi
          rm -f /tmp/feishu_payload.json

      - name: Notify Feishu on failure
        if: failure() && inputs.notify_feishu
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          if [ -z "$FEISHU_WEBHOOK" ]; then
            exit 0
          fi

          cat > /tmp/feishu_fail.json << PAYLOAD_EOF
          {
            "msg_type": "interactive",
            "card": {
              "header": {
                "title": {"tag": "plain_text", "content": "âŒ ${{ inputs.app_name }} æž„å»ºå¤±è´¥"},
                "template": "red"
              },
              "elements": [
                {"tag": "div", "text": {"tag": "lark_md", "content": "**æž„å»ºä¿¡æ¯**\nâ€¢ åˆ†æ”¯: ${{ github.ref_name }}\nâ€¢ æäº¤: ${{ github.sha }}\nâ€¢ è§¦å‘è€…: ${{ github.actor }}"}},
                {"tag": "action", "actions": [{"tag": "button", "text": {"tag": "plain_text", "content": "ðŸ” æŸ¥çœ‹è¯¦æƒ…"}, "type": "default", "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}]}
              ]
            }
          }
          PAYLOAD_EOF

          RESPONSE=$(curl -s -X POST "$FEISHU_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d @/tmp/feishu_fail.json)

          echo "ðŸ“¨ Feishu API response: $RESPONSE"
          rm -f /tmp/feishu_fail.json

      - name: Clean up secrets
        if: always()
        run: |
          rm -f "app/${{ inputs.keystore_filename }}"
          ${{ inputs.decode_secrets_properties && 'rm -f secrets.properties' || 'true' }}
          ${{ inputs.decode_google_services_json && 'rm -f app/src/prod/google-services.json' || 'true' }}
