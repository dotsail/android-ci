name: Android CI/CD (Shared)

on:
  workflow_call:
    inputs:
      # ==================== È°πÁõÆÈÖçÁΩÆ ====================
      app_name:
        description: 'Â∫îÁî®ÂêçÁß∞'
        type: string
        required: true
      build_flavor:
        description: 'ÊûÑÂª∫Âèò‰Ωì: release (Âçïflavor) Êàñ prodRelease (Â§öflavor)'
        type: string
        required: true
      config_path:
        description: 'ÈÖçÁΩÆÊñá‰ª∂Ë∑ØÂæÑ (Áî®‰∫éÊèêÂèñÁâàÊú¨Âè∑)'
        type: string
        required: true
      config_block:
        description: 'awk Ê®°ÂºèÂåπÈÖçÈÖçÁΩÆÂùó (Á©∫=Áõ¥Êé•grep)'
        type: string
        required: false
        default: ''
      ad_config_name:
        description: 'ÂπøÂëäÈÖçÁΩÆÊñá‰ª∂Âêç: boost_config Êàñ lum.config'
        type: string
        required: true
      keystore_filename:
        description: 'Keystore Êñá‰ª∂Âêç'
        type: string
        required: false
        default: 'release-keystore.jks'
      has_maven_credentials:
        description: 'ÊòØÂê¶ÈúÄË¶Å Maven Âá≠ËØÅ'
        type: boolean
        required: false
        default: false
      decode_secrets_properties:
        description: 'ÊòØÂê¶Ëß£Á†Å secrets.properties'
        type: boolean
        required: false
        default: false
      decode_google_services_json:
        description: 'ÊòØÂê¶Ëß£Á†Å google-services.json'
        type: boolean
        required: false
        default: false
      # ==================== ËøêË°åÊó∂ÂèÇÊï∞ ====================
      build_type:
        description: 'ÊûÑÂª∫Á±ªÂûã'
        type: string
        required: true
      create_release:
        description: 'ÂàõÂª∫ GitHub Release'
        type: boolean
        required: false
        default: true
      notify_feishu:
        description: 'ÂèëÈÄÅÈ£û‰π¶ÈÄöÁü•'
        type: boolean
        required: false
        default: true
      also_build_apk:
        description: 'ÂêåÊó∂ÊûÑÂª∫ APK'
        type: boolean
        required: false
        default: false
      upload_debug_artifact:
        description: '‰∏ä‰º† Debug ‰∫ßÁâ©'
        type: boolean
        required: false
        default: false
      publish_to_play_store:
        description: 'ÂèëÂ∏ÉÂà∞ Google Play'
        type: boolean
        required: false
        default: false
      play_store_track:
        description: 'ÂèëÂ∏ÉËΩ®ÈÅì'
        type: string
        required: false
        default: 'internal'
      rollout_percentage:
        description: 'ÁÅ∞Â∫¶ÁôæÂàÜÊØî'
        type: string
        required: false
        default: '20'
      custom_rollout_percentage:
        description: 'Ëá™ÂÆö‰πâÁÅ∞Â∫¶ÁôæÂàÜÊØî'
        type: string
        required: false
        default: ''
      previous_version_action:
        description: '‰∏ä‰∏ÄÁâàÊú¨Â§ÑÁêÜ'
        type: string
        required: false
        default: 'complete'

env:
  JAVA_VERSION: '17'

permissions:
  contents: write
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Derive build configuration
        id: config
        run: |
          FLAVOR="${{ inputs.build_flavor }}"
          APP="${{ inputs.app_name }}"
          if [ "$FLAVOR" = "release" ]; then
            echo "debug_task=assembleDebug" >> $GITHUB_OUTPUT
            echo "release_task=assembleRelease" >> $GITHUB_OUTPUT
            echo "aab_task=bundleRelease" >> $GITHUB_OUTPUT
            echo "debug_apk=app/build/outputs/apk/debug/app-debug.apk" >> $GITHUB_OUTPUT
            echo "release_apk=app/build/outputs/apk/release/app-release.apk" >> $GITHUB_OUTPUT
            echo "aab_path=app/build/outputs/bundle/release/*.aab" >> $GITHUB_OUTPUT
            echo "manifest_dir=release/processReleaseMainManifest" >> $GITHUB_OUTPUT
            echo "assets_dir=release/mergeReleaseAssets" >> $GITHUB_OUTPUT
          else
            echo "debug_task=assembleDevDebug" >> $GITHUB_OUTPUT
            echo "release_task=assembleProdRelease" >> $GITHUB_OUTPUT
            echo "aab_task=bundleProdRelease" >> $GITHUB_OUTPUT
            echo "debug_apk=app/build/outputs/apk/dev/debug/${APP}-dev-debug.apk" >> $GITHUB_OUTPUT
            echo "release_apk=app/build/outputs/apk/prod/release/${APP}-prod-release.apk" >> $GITHUB_OUTPUT
            echo "aab_path=app/build/outputs/bundle/prodRelease/*.aab" >> $GITHUB_OUTPUT
            echo "manifest_dir=prodRelease/processProdReleaseMainManifest" >> $GITHUB_OUTPUT
            echo "assets_dir=prodRelease/mergeProdReleaseAssets" >> $GITHUB_OUTPUT
          fi

      - name: Cleanup old artifacts (keep latest 3)
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üßπ Ê∏ÖÁêÜÊóßÁöÑ artifactsÔºå‰øùÁïôÊúÄÊñ∞ 3 ‰∏™..."
          for ARTIFACT_NAME in "release-apk" "release-aab" "debug-apk"; do
            echo "üì¶ Â§ÑÁêÜ $ARTIFACT_NAME..."
            ARTIFACTS=$(gh api repos/${{ github.repository }}/actions/artifacts \
              --jq ".artifacts | map(select(.name == \"$ARTIFACT_NAME\")) | sort_by(.created_at) | reverse | .[3:] | .[].id")
            if [ -z "$ARTIFACTS" ]; then
              echo "  ‚úÖ $ARTIFACT_NAME Êó†ÈúÄÊ∏ÖÁêÜ"
            else
              for id in $ARTIFACTS; do
                echo "  üóëÔ∏è Âà†Èô§ $ARTIFACT_NAME artifact $id"
                gh api -X DELETE repos/${{ github.repository }}/actions/artifacts/$id || true
              done
            fi
          done
          echo "‚úÖ Ê∏ÖÁêÜÂÆåÊàê"

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Decode Keystore
        if: inputs.build_type != 'debug'
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/${{ inputs.keystore_filename }}

      - name: Decode secrets.properties
        if: inputs.decode_secrets_properties
        run: echo "${{ secrets.SECRETS_PROPERTIES_BASE64 }}" | base64 -d > secrets.properties

      - name: Decode google-services.json
        if: inputs.decode_google_services_json
        run: |
          mkdir -p app/src/prod
          echo "${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}" | base64 -d > app/src/prod/google-services.json

      - name: Print release configuration (pre-build)
        if: inputs.build_type != 'debug'
        run: |
          CONFIG="${{ inputs.config_path }}"
          BLOCK="${{ inputs.config_block }}"

          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë              üìã Release Configuration Summary               ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""

          echo "‚îå‚îÄ‚îÄ‚îÄ üì¶ Âü∫Á°Ä‰ø°ÊÅØ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          APP_ID=""
          VER_NAME=""
          VER_CODE=""
          if [ -n "$BLOCK" ]; then
            BLOCK_TEXT=$(awk "/$BLOCK/,/\]/" "$CONFIG")
            APP_ID=$(echo "$BLOCK_TEXT" | grep 'applicationId' | head -1 | sed 's/.*"\(.*\)".*/\1/')
            VER_NAME=$(echo "$BLOCK_TEXT" | grep 'versionName' | head -1 | sed 's/.*"\(.*\)".*/\1/')
            VER_CODE=$(echo "$BLOCK_TEXT" | grep 'versionCode' | head -1 | sed 's/[^0-9]*\([0-9]*\).*/\1/')
          fi
          [ -z "$APP_ID" ] && APP_ID=$(grep 'applicationId' "$CONFIG" | head -1 | sed 's/.*"\(.*\)".*/\1/' || echo 'N/A')
          [ -z "$VER_NAME" ] && VER_NAME=$(grep 'versionName' "$CONFIG" | head -1 | sed 's/.*"\(.*\)".*/\1/' || echo 'N/A')
          [ -z "$VER_CODE" ] && VER_CODE=$(grep 'versionCode' "$CONFIG" | head -1 | sed 's/[^0-9]*\([0-9]*\).*/\1/' || echo 'N/A')
          echo "‚îÇ Application ID:  $APP_ID"
          echo "‚îÇ Version Name:    $VER_NAME"
          echo "‚îÇ Version Code:    $VER_CODE"
          echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo ""

          # Firebase config (search common paths)
          GOOGLE_SERVICES=""
          for path in "app/src/release/google-services.json" "app/src/prod/google-services.json" "app/google-services.json"; do
            if [ -f "$path" ]; then GOOGLE_SERVICES="$path"; break; fi
          done

          if [ -n "$GOOGLE_SERVICES" ]; then
            echo "‚îå‚îÄ‚îÄ‚îÄ üî• Firebase ÈÖçÁΩÆ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
            echo "‚îÇ Source:          $GOOGLE_SERVICES"
            echo "‚îÇ Project ID:      $(grep -o '"project_id": "[^"]*"' "$GOOGLE_SERVICES" | head -1 | sed 's/.*"\([^"]*\)"/\1/' || echo 'N/A')"
            echo "‚îÇ Package Name:    $(grep -o '"package_name": "[^"]*"' "$GOOGLE_SERVICES" | head -1 | sed 's/.*"\([^"]*\)"/\1/' || echo 'N/A')"
            echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          fi
          echo ""
          echo "‚úÖ Ê∫êÁ†ÅÈÖçÁΩÆÊ†∏Êü•ÂÆåÊàê"
          echo "‚ÑπÔ∏è ÂπøÂëäËÅöÂêàÂπ≥Âè∞ËØ¶ÁªÜÈÖçÁΩÆÂ∞ÜÂú®ÊûÑÂª∫Âêé‰ªé ${{ inputs.ad_config_name }} Ëß£ÂØÜËæìÂá∫"

      - name: Build Debug APK
        if: inputs.build_type == 'debug' || inputs.build_type == 'both'
        env:
          ORG_GRADLE_PROJECT_MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          ORG_GRADLE_PROJECT_MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
        run: ./gradlew ${{ steps.config.outputs.debug_task }}

      - name: Build Release APK
        if: |
          (inputs.build_type == 'release' || inputs.build_type == 'both' || inputs.build_type == '') &&
          inputs.build_type != 'aab' &&
          (!inputs.publish_to_play_store || inputs.also_build_apk)
        env:
          KEYSTORE_FILE: ${{ inputs.keystore_filename }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          ORG_GRADLE_PROJECT_MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          ORG_GRADLE_PROJECT_MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
        run: ./gradlew ${{ steps.config.outputs.release_task }}

      - name: Build Release AAB (for Google Play)
        if: inputs.publish_to_play_store || inputs.build_type == 'aab'
        env:
          KEYSTORE_FILE: ${{ inputs.keystore_filename }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          ORG_GRADLE_PROJECT_MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          ORG_GRADLE_PROJECT_MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
        run: ./gradlew ${{ steps.config.outputs.aab_task }}

      - name: Get version info
        id: version
        run: |
          CONFIG="${{ inputs.config_path }}"
          BLOCK="${{ inputs.config_block }}"

          if [ ! -f "$CONFIG" ]; then
            echo "‚ùå Error: $CONFIG not found"
            exit 1
          fi

          if [ -n "$BLOCK" ]; then
            BLOCK_TEXT=$(awk "/$BLOCK/,/\]/" "$CONFIG")
            VERSION_NAME=$(echo "$BLOCK_TEXT" | grep "versionName" | head -1 | sed 's/.*"\(.*\)".*/\1/')
            VERSION_CODE=$(echo "$BLOCK_TEXT" | grep "versionCode" | head -1 | sed 's/[^0-9]*\([0-9]*\).*/\1/')
            PACKAGE_NAME=$(echo "$BLOCK_TEXT" | grep "applicationId" | head -1 | sed 's/.*"\(.*\)".*/\1/')
          fi

          # Fallback to global grep if block extraction missed any field
          if [ -z "$VERSION_NAME" ]; then
            VERSION_NAME=$(grep "versionName" "$CONFIG" | head -1 | sed 's/.*"\(.*\)".*/\1/')
          fi
          if [ -z "$VERSION_CODE" ]; then
            VERSION_CODE=$(grep "versionCode" "$CONFIG" | head -1 | sed 's/[^0-9]*\([0-9]*\).*/\1/')
          fi
          if [ -z "$PACKAGE_NAME" ]; then
            PACKAGE_NAME=$(grep "applicationId" "$CONFIG" | head -1 | sed 's/.*"\(.*\)".*/\1/')
          fi

          if [ -z "$VERSION_NAME" ] || [ -z "$VERSION_CODE" ] || [ -z "$PACKAGE_NAME" ]; then
            echo "‚ùå Error: Failed to extract version info from $CONFIG"
            exit 1
          fi

          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "build_time=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT

          echo "‚úÖ Version Name: $VERSION_NAME"
          echo "‚úÖ Version Code: $VERSION_CODE"
          echo "üì¶ Package Name: $PACKAGE_NAME"

      - name: Print ad configuration (post-build)
        if: inputs.build_type != 'debug'
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë         üì∫ Ad Configuration (${{ inputs.ad_config_name }})              ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""

          # AdMob App ID from merged manifest
          MANIFEST_FILE="app/build/intermediates/merged_manifest/${{ steps.config.outputs.manifest_dir }}/AndroidManifest.xml"
          echo "‚îå‚îÄ‚îÄ‚îÄ üè∑Ô∏è AdMob App ID (AndroidManifest.xml) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          if [ -f "$MANIFEST_FILE" ]; then
            ADMOB_APP_ID=$(grep -A1 'com.google.android.gms.ads.APPLICATION_ID' "$MANIFEST_FILE" | grep 'android:value' | sed 's/.*"\(.*\)".*/\1/')
            echo "‚îÇ AdMob App ID:    $ADMOB_APP_ID"
          else
            echo "‚îÇ ‚ö†Ô∏è merged AndroidManifest.xml ‰∏çÂ≠òÂú®"
          fi
          echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo ""

          # Decrypt ad config (AES-256-CBC, same key/IV for both boost_config and lum.config)
          AD_KEY="6ebd5bacec777becb70c4a04b9ff68e3229e6f71f3a4ca40932f53548d402fe4"
          AD_IV="3f20787529787aec5a472f07b0ef4bea"
          AD_FILE="app/build/intermediates/assets/${{ steps.config.outputs.assets_dir }}/${{ inputs.ad_config_name }}"

          if [ -f "$AD_FILE" ]; then
            DECRYPTED=$(base64 -d "$AD_FILE" | openssl enc -d -aes-256-cbc -K "$AD_KEY" -iv "$AD_IV" 2>/dev/null) || true

            if [ -n "$DECRYPTED" ]; then
              # Try to extract ad scene names from config for cross-validation
              GRADLE_SCENES=""
              for f in "${{ inputs.config_path }}" "config.gradle" "config/config.gradle"; do
                if [ -f "$f" ]; then
                  GRADLE_SCENES=$(awk '/adScenes.*=.*\[/,/\]/' "$f" 2>/dev/null | grep -o '"[^"]*"' | tr -d '"' | sort) || true
                  if [ -n "$GRADLE_SCENES" ]; then break; fi
                fi
              done
              export GRADLE_SCENES="${GRADLE_SCENES:-}"

              cat << 'PYEOF' > /tmp/ad_parser.py
          import json, sys, os

          config = json.load(sys.stdin)

          print('‚îå‚îÄ‚îÄ‚îÄ üì± ÂπøÂëäËÅöÂêàÂπ≥Âè∞ (v' + config.get('version', '?') + ') ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ')
          print('‚îÇ Global Switch:   ' + str(config.get('switch', '?')))
          print('‚îÇ')

          networks = config.get('networks', {})

          admob = networks.get('admob', {})
          print('‚îÇ [AdMob]          network_id=' + str(admob.get('id', '?')))

          topon = networks.get('topOn', {})
          print('‚îÇ [TopOn]          network_id=' + str(topon.get('id', '?')))
          print('‚îÇ   App ID:        ' + topon.get('app_id', 'Êú™ÈÖçÁΩÆ'))
          print('‚îÇ   App Key:       ' + topon.get('app_key', 'Êú™ÈÖçÁΩÆ'))

          maxn = networks.get('max', {})
          sdk_key = maxn.get('applovin_sdk_key', '')
          print('‚îÇ [MAX/AppLovin]   network_id=' + str(maxn.get('id', '?')))
          if sdk_key:
              print('‚îÇ   SDK Key:       ' + sdk_key[:20] + '...' + sdk_key[-10:] + ' (' + str(len(sdk_key)) + ' chars)')
          else:
              print('‚îÇ   SDK Key:       Êú™ÈÖçÁΩÆ')

          adx = networks.get('adx', {})
          if adx:
              print('‚îÇ [ADX]            network_id=' + str(adx.get('id', '?')))
              print('‚îÇ   App ID:        ' + adx.get('app_id', 'Êú™ÈÖçÁΩÆ'))

          print('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ')
          print()

          print('‚îå‚îÄ‚îÄ‚îÄ üì∫ ÂπøÂëäÂú∫ÊôØ ‚Üî ÂπøÂëäÂçïÂÖÉ ID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ')

          strategies = {}
          for s in (config.get('strategies') or []):
              sid = s['id']
              strategies[int(sid) if isinstance(sid, str) else sid] = s

          network_names = {2: 'AdMob', 5: 'MAX', 26: 'TopOn', 66: 'ADX'}
          ad_type_names = {1: 'ÊèíÂ±è', 2: 'ÊøÄÂä±', 3: 'ÂéüÁîü', 4: 'ÂºÄÂ±è', 5: 'Banner'}

          for scene in (config.get('scenes') or []):
              name = scene['name']
              sid = scene['strategy_id']
              switch = '‚úÖ' if scene.get('switch', 1) == 1 else '‚ùå'
              ad_type = ad_type_names.get(scene.get('ad_type', 0), str(scene.get('ad_type', '?')))
              bidding = 'Á´û‰ª∑' if scene.get('enable_client_bidding', False) else 'ÁÄëÂ∏ÉÊµÅ'
              print(f'‚îÇ {switch} {name}')
              print(f'‚îÇ   Á±ªÂûã: {ad_type}  |  Ê®°Âºè: {bidding}  |  Á≠ñÁï•ID: {sid}')
              strategy = strategies.get(sid)
              if strategy:
                  for unit in strategy.get('ad_units', []):
                      net = network_names.get(unit.get('network', 0), 'N' + str(unit.get('network', '?')))
                      print(f'‚îÇ   ‚Üí [{net}] {unit["id"]}')
              else:
                  print(f'‚îÇ   ‚Üí ‚ö†Ô∏è Á≠ñÁï• {sid} Êú™ÊâæÂà∞')

          print('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ')
          print()

          ad_scenes = set(s['name'] for s in (config.get('scenes') or []))
          gradle_scenes_str = os.environ.get('GRADLE_SCENES', '').strip()
          gradle_scenes = set(gradle_scenes_str.split('\n')) if gradle_scenes_str else set()

          if gradle_scenes:
              print('‚îå‚îÄ‚îÄ‚îÄ üîç ÂπøÂëäÂú∫ÊôØ‰∫§ÂèâÊ†°È™å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ')
              missing = gradle_scenes - ad_scenes
              extra = ad_scenes - gradle_scenes
              if not missing and not extra:
                  print('‚îÇ ‚úÖ config ÂíåÂπøÂëäÈÖçÁΩÆÂú∫ÊôØÂÆåÂÖ®ÂåπÈÖç')
              else:
                  if missing:
                      for s in sorted(missing):
                          print(f'‚îÇ ‚ö†Ô∏è config ‰∏≠Êúâ‰ΩÜÂπøÂëäÈÖçÁΩÆ‰∏≠Áº∫Â§±: {s}')
                  if extra:
                      for s in sorted(extra):
                          print(f'‚îÇ ‚ÑπÔ∏è ÂπøÂëäÈÖçÁΩÆ‰∏≠Êúâ‰ΩÜ config ‰∏≠Êú™ÂÆö‰πâ: {s}')
              print('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ')
          PYEOF
              echo "$DECRYPTED" | python3 /tmp/ad_parser.py
            else
              echo "‚îå‚îÄ‚îÄ‚îÄ üì± ÂπøÂëäËÅöÂêàÂπ≥Âè∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
              echo "‚îÇ ‚ö†Ô∏è ${{ inputs.ad_config_name }} Ëß£ÂØÜÂ§±Ë¥•"
              echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
            fi
          else
            echo "‚îå‚îÄ‚îÄ‚îÄ üì± ÂπøÂëäËÅöÂêàÂπ≥Âè∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
            echo "‚îÇ ‚ö†Ô∏è ${{ inputs.ad_config_name }} Êñá‰ª∂‰∏çÂ≠òÂú® (ÈúÄË¶Å release/aab ÊûÑÂª∫)"
            echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          fi

          echo ""
          echo "‚úÖ ÂπøÂëäÈÖçÁΩÆÊ†∏Êü•ÂÆåÊàê"

      - name: Generate Changelog
        id: changelog
        if: inputs.publish_to_play_store && inputs.play_store_track == 'production'
        run: |
          chmod +x scripts/generate-changelog.sh
          ./scripts/generate-changelog.sh --dry-run

      - name: Rename APK files
        if: ${{ (!inputs.publish_to_play_store || inputs.also_build_apk) || inputs.build_type == 'debug' || inputs.build_type == 'both' }}
        run: |
          mkdir -p artifacts
          if [ -f "${{ steps.config.outputs.debug_apk }}" ]; then
            cp "${{ steps.config.outputs.debug_apk }}" "artifacts/${{ inputs.app_name }}-v${{ steps.version.outputs.version_name }}-debug.apk"
          fi
          if [ -f "${{ steps.config.outputs.release_apk }}" ]; then
            cp "${{ steps.config.outputs.release_apk }}" "artifacts/${{ inputs.app_name }}-v${{ steps.version.outputs.version_name }}-release.apk"
          fi

      - name: Upload Debug APK artifact
        if: inputs.upload_debug_artifact && (inputs.build_type == 'debug' || inputs.build_type == 'both')
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: debug-apk
          path: artifacts/*-debug.apk
          if-no-files-found: ignore

      - name: Upload Release APK artifact
        if: ${{ !inputs.publish_to_play_store || inputs.also_build_apk }}
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: release-apk
          path: artifacts/*-release.apk
          if-no-files-found: ignore

      - name: Upload Release AAB artifact
        if: inputs.publish_to_play_store || inputs.build_type == 'aab'
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: release-aab
          path: ${{ steps.config.outputs.aab_path }}
          if-no-files-found: warn

      - name: Create Stable Tag
        if: inputs.publish_to_play_store && inputs.play_store_track == 'production'
        run: |
          VERSION="v${{ steps.version.outputs.version_name }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Tag $VERSION Â∑≤Â≠òÂú®ÔºåË∑≥ËøáÂàõÂª∫"
          else
            echo "üìå ÂàõÂª∫Ê≠£Âºè Tag: $VERSION"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "$VERSION" -m "Release $VERSION"
            git push origin "$VERSION"
            echo "‚úÖ Tag $VERSION ÂàõÂª∫ÊàêÂäü"
          fi

      - name: Create Release
        if: inputs.create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ (inputs.publish_to_play_store && inputs.play_store_track == 'production') && format('v{0}', steps.version.outputs.version_name) || format('v{0}-{1}', steps.version.outputs.version_name, steps.version.outputs.build_time) }}
          name: Release v${{ steps.version.outputs.version_name }}
          body: |
            ## ${{ inputs.app_name }} v${{ steps.version.outputs.version_name }}

            **ÁâàÊú¨‰ø°ÊÅØ**
            - Version Name: ${{ steps.version.outputs.version_name }}
            - Version Code: ${{ steps.version.outputs.version_code }}
            - Build Time: ${{ steps.version.outputs.build_time }}

            ## ‰∏ãËΩΩ

            ÁÇπÂáª‰∏ãÊñπ Assets ‰∏≠ÁöÑ APK Êñá‰ª∂‰∏ãËΩΩÂÆâË£Ö„ÄÇ
          files: artifacts/*.apk
          fail_on_unmatched_files: false
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate rollout settings
        id: rollout
        if: inputs.publish_to_play_store
        run: |
          TRACK="${{ inputs.play_store_track }}"
          CUSTOM_PERCENTAGE="${{ inputs.custom_rollout_percentage }}"
          CHOICE_PERCENTAGE="${{ inputs.rollout_percentage }}"

          if [ -n "$CUSTOM_PERCENTAGE" ]; then
            PERCENTAGE="$CUSTOM_PERCENTAGE"
            echo "üìù ‰ΩøÁî®Ëá™ÂÆö‰πâÁÅ∞Â∫¶ÁôæÂàÜÊØî: ${PERCENTAGE}%"
          else
            PERCENTAGE="$CHOICE_PERCENTAGE"
            echo "üìù ‰ΩøÁî®È¢ÑËÆæÁÅ∞Â∫¶ÁôæÂàÜÊØî: ${PERCENTAGE}%"
          fi

          if ! [[ "$PERCENTAGE" =~ ^[0-9]+$ ]] || [ "$PERCENTAGE" -lt 1 ] || [ "$PERCENTAGE" -gt 100 ]; then
            echo "‚ùå Error: ÁÅ∞Â∫¶ÁôæÂàÜÊØîÂøÖÈ°ªÊòØ 1-100 ‰πãÈó¥ÁöÑÊï¥Êï∞ÔºåÂΩìÂâçÂÄº: $PERCENTAGE"
            exit 1
          fi

          if [ "$TRACK" = "production" ]; then
            echo "‚ö†Ô∏è =================================="
            echo "‚ö†Ô∏è Ë≠¶Âëä: Ê≠£Âú®ÂèëÂ∏ÉÂà∞ PRODUCTION ËΩ®ÈÅì!"
            echo "‚ö†Ô∏è =================================="
          fi

          echo "üìã ÂèëÂ∏ÉÈÖçÁΩÆ:"
          echo "   ËΩ®ÈÅì: $TRACK"
          echo "   ÁÅ∞Â∫¶: ${PERCENTAGE}%"
          echo "   ‰∏ä‰∏ÄÁâàÊú¨: ${{ inputs.previous_version_action }}"

          if [ "$PERCENTAGE" = "100" ]; then
            echo "fraction=" >> $GITHUB_OUTPUT
            echo "status=completed" >> $GITHUB_OUTPUT
            echo "üìä ÂèëÂ∏ÉËÆæÁΩÆ: 100% ÂÖ®ÈáèÂèëÂ∏É"
          else
            FRACTION=$(awk "BEGIN {printf \"%.2f\", $PERCENTAGE / 100}")
            echo "fraction=$FRACTION" >> $GITHUB_OUTPUT
            echo "status=inProgress" >> $GITHUB_OUTPUT
            echo "üìä ÂèëÂ∏ÉËÆæÁΩÆ: ${PERCENTAGE}% ÁÅ∞Â∫¶ÂèëÂ∏É (userFraction: $FRACTION)"
          fi

      - name: Handle previous version
        if: inputs.publish_to_play_store && inputs.previous_version_action != 'keep'
        continue-on-error: true
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          chmod +x scripts/manage-previous-release.sh
          ./scripts/manage-previous-release.sh \
            "${{ steps.version.outputs.package_name }}" \
            "${{ inputs.play_store_track }}" \
            "${{ inputs.previous_version_action }}" \
            "$GOOGLE_PLAY_SERVICE_ACCOUNT_JSON"

      - name: Upload to Google Play
        if: inputs.publish_to_play_store
        continue-on-error: true
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ steps.version.outputs.package_name }}
          releaseFiles: ${{ steps.config.outputs.aab_path }}
          track: ${{ inputs.play_store_track }}
          status: ${{ steps.rollout.outputs.status }}
          userFraction: ${{ steps.rollout.outputs.fraction }}
          whatsNewDirectory: distribution/whatsnew

      - name: Upload APK to file hosting
        id: upload
        if: always() && !cancelled()
        run: |
          APK_FILE="artifacts/${{ inputs.app_name }}-v${{ steps.version.outputs.version_name }}-release.apk"
          if [ -f "$APK_FILE" ]; then
            for i in 1 2 3; do
              echo "üì§ ‰∏ä‰º†Â∞ùËØï $i/3..."
              RESPONSE=$(curl --connect-timeout 30 --max-time 300 -F "file=@${APK_FILE}" https://tmpfiles.org/api/v1/upload 2>/dev/null)
              RAW_URL=$(echo "$RESPONSE" | grep -o '"url":"[^"]*"' | cut -d'"' -f4)
              if [ -n "$RAW_URL" ]; then
                DOWNLOAD_URL=$(echo "$RAW_URL" | sed 's|tmpfiles.org/|tmpfiles.org/dl/|')
                echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
                echo "‚úÖ APK uploaded: $DOWNLOAD_URL"
                break
              fi
              if [ $i -lt 3 ]; then
                echo "‚ö†Ô∏è ‰∏ä‰º†Â§±Ë¥•Ôºå10ÁßíÂêéÈáçËØï..."
                sleep 10
              fi
            done
            if [ -z "$DOWNLOAD_URL" ] || [[ "$DOWNLOAD_URL" != http* ]]; then
              echo "‚ö†Ô∏è Failed to upload APK after 3 attempts"
              echo "download_url=" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ö†Ô∏è APK file not found"
            echo "download_url=" >> $GITHUB_OUTPUT
          fi

      - name: Notify Feishu
        if: always() && !cancelled() && !failure() && inputs.notify_feishu
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          if [ -z "$FEISHU_WEBHOOK" ]; then
            echo "‚ö†Ô∏è FEISHU_WEBHOOK not configured, skipping notification"
            exit 0
          fi

          DOWNLOAD_URL="${{ steps.upload.outputs.download_url }}"
          VERSION_NAME="${{ steps.version.outputs.version_name }}"
          VERSION_CODE="${{ steps.version.outputs.version_code }}"
          BUILD_TIME="${{ steps.version.outputs.build_time }}"

          if [ -n "$DOWNLOAD_URL" ] && [[ "$DOWNLOAD_URL" == http* ]]; then
            QR_CODE_URL="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${DOWNLOAD_URL}"
            DOWNLOAD_SECTION="$(cat <<INNER_EOF
                  {
                    \"tag\": \"hr\"
                  },
                  {
                    \"tag\": \"div\",
                    \"text\": {
                      \"tag\": \"lark_md\",
                      \"content\": \"**‰∏ãËΩΩÈìæÊé•Ôºà1Â∞èÊó∂ÊúâÊïàÔºâ**\n[ÁÇπÂáªÊü•Áúã‰∫åÁª¥Á†Å](${QR_CODE_URL})\"
                    }
                  },
                  {
                    \"tag\": \"action\",
                    \"actions\": [
                      {
                        \"tag\": \"button\",
                        \"text\": {
                          \"tag\": \"plain_text\",
                          \"content\": \"üì• ‰∏ãËΩΩ APK\"
                        },
                        \"type\": \"primary\",
                        \"url\": \"${DOWNLOAD_URL}\"
                      }
                    ]
                  }
          INNER_EOF
          )"
          else
            DOWNLOAD_SECTION="$(cat <<INNER_EOF
                  {
                    \"tag\": \"hr\"
                  },
                  {
                    \"tag\": \"div\",
                    \"text\": {
                      \"tag\": \"lark_md\",
                      \"content\": \"**APK ‰∏ãËΩΩÈìæÊé•‰∏çÂèØÁî®**\nËØ∑ÂâçÂæÄ [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) ‰∏ãËΩΩ Artifacts\"
                    }
                  }
          INNER_EOF
          )"
          fi

          PAYLOAD="{
              \"msg_type\": \"interactive\",
              \"card\": {
                \"header\": {
                  \"title\": {
                    \"tag\": \"plain_text\",
                    \"content\": \"‚úÖ ${{ inputs.app_name }} ÊûÑÂª∫ÊàêÂäü\"
                  },
                  \"template\": \"green\"
                },
                \"elements\": [
                  {
                    \"tag\": \"div\",
                    \"text\": {
                      \"tag\": \"lark_md\",
                      \"content\": \"**ÁâàÊú¨‰ø°ÊÅØ**\n‚Ä¢ Version: ${VERSION_NAME} (${VERSION_CODE})\n‚Ä¢ ÊûÑÂª∫Êó∂Èó¥: ${BUILD_TIME}\n‚Ä¢ ÂàÜÊîØ: ${{ github.ref_name }}\"
                    }
                  },
                  ${DOWNLOAD_SECTION}
                ]
              }
            }"

          echo "üì§ Sending Feishu notification..."
          echo "üìã Payload preview (first 500 chars):"
          echo "$PAYLOAD" | head -c 500
          echo ""

          RESPONSE=$(curl -s -X POST "$FEISHU_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          echo "üì® Feishu API response: $RESPONSE"

          STATUS_CODE=$(echo "$RESPONSE" | python3 -c "import json,sys; d=json.load(sys.stdin); print(d.get('StatusCode', d.get('code', -1)))" 2>/dev/null || echo "-1")
          if [ "$STATUS_CODE" = "0" ]; then
            echo "‚úÖ Feishu notification sent successfully"
          else
            echo "‚ùå Feishu notification failed! StatusCode=$STATUS_CODE"
            echo "Full response: $RESPONSE"
          fi

      - name: Notify Feishu on failure
        if: failure() && inputs.notify_feishu
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          if [ -z "$FEISHU_WEBHOOK" ]; then
            exit 0
          fi

          RESPONSE=$(curl -s -X POST "$FEISHU_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{
              \"msg_type\": \"interactive\",
              \"card\": {
                \"header\": {
                  \"title\": {
                    \"tag\": \"plain_text\",
                    \"content\": \"‚ùå ${{ inputs.app_name }} ÊûÑÂª∫Â§±Ë¥•\"
                  },
                  \"template\": \"red\"
                },
                \"elements\": [
                  {
                    \"tag\": \"div\",
                    \"text\": {
                      \"tag\": \"lark_md\",
                      \"content\": \"**ÊûÑÂª∫‰ø°ÊÅØ**\n‚Ä¢ ÂàÜÊîØ: ${{ github.ref_name }}\n‚Ä¢ Êèê‰∫§: ${{ github.sha }}\n‚Ä¢ Ëß¶ÂèëËÄÖ: ${{ github.actor }}\"
                    }
                  },
                  {
                    \"tag\": \"action\",
                    \"actions\": [
                      {
                        \"tag\": \"button\",
                        \"text\": {
                          \"tag\": \"plain_text\",
                          \"content\": \"üîç Êü•ÁúãËØ¶ÊÉÖ\"
                        },
                        \"type\": \"default\",
                        \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                      }
                    ]
                  }
                ]
              }
            }")

          echo "üì® Feishu API response: $RESPONSE"

      - name: Clean up secrets
        if: always()
        run: |
          rm -f "app/${{ inputs.keystore_filename }}"
          ${{ inputs.decode_secrets_properties && 'rm -f secrets.properties' || 'true' }}
          ${{ inputs.decode_google_services_json && 'rm -f app/src/prod/google-services.json' || 'true' }}
